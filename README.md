# Class Backend POC

Monolithic Go backend showcasing **Clean/Hexagonal Architecture** and **multi-tenant RBAC authorization**.
APIs are exposed via **HTTP REST (Gin + Huma)** with autogenerated **OpenAPI 3.1 docs**.

**Stack:** Go, Gin, Huma, PostgreSQL, SQLC, Atlas, Casbin,

---

## Project Structure

```
â”œâ”€â”€ class/           # Infrastructure (HTTP, adapters, auth, utils)
â”‚   â”œâ”€â”€ auth/        # Auth module
â”‚   â”œâ”€â”€ user/        # User module
â”‚   â””â”€â”€ shared/      # Casbin, middleware, utils
â”œâ”€â”€ core/            # Domain + Application layer
â”‚   â”œâ”€â”€ app/         # Use cases
â”‚   â””â”€â”€ tests/       # Unit tests
â”œâ”€â”€ configs/         # Casbin model, env configs
â”œâ”€â”€ migrations/      # DB migrations (Atlas)
â””â”€â”€ docs/            # ADRs, detailed design docs
```

---

## RBAC Authorization

Authorization is powered by **Casbin** with tenant-aware policies.
Each request requires:

* **JWT** for authentication
* **X-Tenant-Id** header for tenant context

### Roles

* **Admin** â†’ full tenant access (manage users, courses, roles)
* **Instructor** â†’ manage courses, students, grades
* **Student** â†’ access personal profile, enrollments, submissions

### Example Policy (`policies.yaml`)

```yaml
roles:
  admin:
    permissions:
      all: [all]

  instructor:
    permissions:
      assignment: [create, view, edit, grade]
      course: [view, edit]  # only their courses
      student: [view]       # enrolled students
      grade: [assign, view]

  student:
    permissions:
      assignment: [view, submit]
      course: [view]
      grade: [view]         # only their grades
      profile: [edit]       # their own profile
```

This ensures isolation: roles are **scoped per tenant**, so `admin_tenant1` cannot act in `tenant2`.

---

## API Examples

### Health

```bash
curl -X GET http://localhost:8081/health \
  -H "Content-Type: application/json" \
```

Docs available at:

```
http://localhost:8081/docs
```

---

## ðŸš€ Getting Started

### Prerequisites

Before setting up this project, ensure you have the following tools installed:

| Tool | Version | Installation |
|------|---------|-------------|
| **Go** | 1.24+ | [Download](https://golang.org/dl/) |
| **Docker** | Latest | [Download](https://docs.docker.com/get-docker/) |
| **Atlas CLI** | v0.36+ | `go install ariga.io/atlas/cmd/atlas@latest` |
| **Air** | v1.62+ | `go install github.com/air-verse/air@latest` |
| **SQLC** | Latest | `go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest` |

### Quick Setup

**Option 1: Using Makefile (Recommended)**
```bash
# Clone the repository
git clone <your-repo-url>
cd class-backend-poc

# Complete setup and start development server
make dev-setup
```

**Option 2: Manual Setup**
```bash
# 1. Start PostgreSQL database
make db-up
# or: docker compose up -d

# 2. Apply database migrations  
make migrate
# or: atlas migrate apply --env local

# 3. Generate SQLC code
make generate  
# or: sqlc generate

# 4. Start development server with hot reload
make dev
# or: air
```

### Verify Setup

After setup, verify everything is working:

1. **Health Check**: Visit http://localhost:8081/health
2. **API Documentation**: Visit http://localhost:8081/docs
3. **Run Tests**: `make test` or `go test ./... -cover`

### Development Workflow

```bash
# Start development (with hot reload)
make dev

# Run tests
make test

# Apply new migrations
make migrate

# Regenerate SQLC code (after schema changes)
make generate

# Stop database
make db-down
```

### Available Make Commands

Run `make help` to see all available commands:
- `make db-up` - Start PostgreSQL database
- `make migrate` - Apply database migrations
- `make generate` - Generate SQLC code  
- `make dev` - Start development server
- `make build` - Build the application
- `make test` - Run tests
- `make setup` - Setup development environment
- `make dev-setup` - Complete setup + start server

---

## Testing

```bash
go test ./... -cover
```

---

## Config

`.env` example:

```
DATABASE_URL=postgres://postgres:postgres@localhost:5437/edoo_class?sslmode=disable
HTTP_PORT=8081
JWT_SECRET=your-secret
```

---

## Contributing

* Add business logic in **core/** first
* Implement use cases in **app/**
* Wire up adapters + handlers in **class/**
* Extend RBAC rules in `policies.yaml`
* Cover with tests
