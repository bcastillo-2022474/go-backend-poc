# Class Backend POC

Monolithic Go backend showcasing **Clean/Hexagonal Architecture** and **multi-tenant RBAC authorization**.
APIs are exposed via **HTTP REST (Gin + Huma)** with autogenerated **OpenAPI 3.1 docs**.

**Stack:** Go, Gin, Huma, PostgreSQL, SQLC, Atlas, Casbin,

---

## Project Structure

```
├── class/           # Infrastructure (HTTP, adapters, auth, utils)
│   ├── auth/        # Auth module
│   ├── user/        # User module
│   └── shared/      # Casbin, middleware, utils
├── core/            # Domain + Application layer
│   ├── app/         # Use cases
│   └── tests/       # Unit tests
├── configs/         # Casbin model, env configs
├── migrations/      # DB migrations (Atlas)
└── docs/            # ADRs, detailed design docs
```

---

## RBAC Authorization

Authorization is powered by **Casbin** with tenant-aware policies.
Each request requires:

* **JWT** for authentication
* **X-Tenant-Id** header for tenant context

### Roles

* **Admin** → full tenant access (manage users, courses, roles)
* **Instructor** → manage courses, students, grades
* **Student** → access personal profile, enrollments, submissions

### Example Policy (`policies.yaml`)

```yaml
roles:
  admin:
    permissions:
      all: [all]

  instructor:
    permissions:
      assignment: [create, view, edit, grade]
      course: [view, edit]  # only their courses
      student: [view]       # enrolled students
      grade: [assign, view]

  student:
    permissions:
      assignment: [view, submit]
      course: [view]
      grade: [view]         # only their grades
      profile: [edit]       # their own profile
```

This ensures isolation: roles are **scoped per tenant**, so `admin_tenant1` cannot act in `tenant2`.

---

## API Examples

### Health

```bash
curl -X GET http://localhost:8081/health \
  -H "Content-Type: application/json" \
```

Docs available at:

```
http://localhost:8081/docs
```

---

## Development Setup

**Requirements:** Go 1.21+, Docker, Atlas CLI

```bash
docker-compose up -d                # start DB
atlas migrate apply --env local     # apply migrations
cd class/user && sqlc generate      # generate SQLC code
go run class/main.go                # run server
```

---

## Testing

```bash
go test ./... -cover
```

---

## Config

`.env` example:

```
DATABASE_URL=postgres://postgres:postgres@localhost:5437/edoo_class?sslmode=disable
HTTP_PORT=8081
JWT_SECRET=your-secret
```

---

## Contributing

* Add business logic in **core/** first
* Implement use cases in **app/**
* Wire up adapters + handlers in **class/**
* Extend RBAC rules in `policies.yaml`
* Cover with tests
